openapi: 3.1.0
info:
  version: 1.0.0
  title: Bilxtra Product APIs
  description: |
    APIs for searching products, finding compatible Thule racks, and retrieving vehicle details.
    
    Common use cases:
    1. Finding a roof rack:
       - Get car details via /api/vehicle-lookup (with plate)
       - Find compatible racks via /api/thule/lookup
       - Or enter car details manually
    
    2. Finding accessories:
       - Get car specs via /api/vehicle-lookup
       - Search products via /api/product-search
       - Use car details to select variants
  contact:
    url: https://bilxtra.no

servers:
  - url: https://bilxtra-product-updater.vercel.app
    description: Production API server

paths:
  /api/product-search:
    get:
      operationId: searchProducts
      summary: Search for products in the Crystallize catalog
      description: |
        Returns a list of products matching the search term, with cleaned URLs for Bilxtra.no.
        Products with stock less than 3 are filtered out to ensure availability.
        Results are limited to top 5 matches.
      parameters:
        - name: q
          in: query
          required: true
          description: The search term to find products (matches against product name or SKU)
          schema:
            type: string
            example: "ladekabel til etron"
      responses:
        '200':
          description: A list of products matching the search criteria (max 5 results, stock >= 3)
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required:
                    - name
                    - itemId
                    - url
                    - variant
                  properties:
                    name:
                      type: string
                      description: The name of the product
                      example: "BAG TIL LADEKABEL PACKLINE"
                    itemId:
                      type: string
                      description: Unique identifier for the product in Crystallize
                      example: "670e7081b31888406ab9c536"
                    url:
                      type: string
                      description: Clean URL to the product page on Bilxtra.no
                      example: "https://bilxtra.no/utstyr/elbil-og-hybrid/tilbehor/bag-til-ladekabel-packline"
                    variant:
                      type: object
                      required:
                        - sku
                        - name
                        - image
                        - price
                        - priceExVat
                        - stock
                        - totalStock
                      properties:
                        sku:
                          type: string
                          description: Product SKU (Stock Keeping Unit)
                          example: "LAD-11009663"
                        name:
                          type: string
                          description: Variant name/description
                          example: "BAG TIL LADEKABEL PACKLINE"
                        image:
                          type: object
                          required:
                            - url
                            - key
                          properties:
                            url:
                              type: string
                              description: URL to the product image
                              example: "https://media.crystallize.com/bilxtra-prod/24/10/16/1/pac-11009663-packline-ladekabelbag-01.jpg"
                            key:
                              type: string
                              description: Crystallize media key for the image
                              example: "bilxtra-prod/24/10/16/1/pac-11009663-packline-ladekabelbag-01.jpg"
                        price:
                          type: number
                          description: The price of the product variant in NOK, including 25% VAT
                          example: 199.00
                        priceExVat:
                          type: number
                          description: The price of the product variant in NOK, excluding VAT
                          example: 159.20
                        stock:
                          type: number
                          description: The current stock level of the product variant (always >= 3)
                          example: 15
                        totalStock:
                          type: number
                          description: Total stock across all locations
                          example: 42
        '400':
          description: Bad request - missing search term
          content:
            application/json:
              schema:
                type: object
                required:
                  - error
                properties:
                  error:
                    type: string
                    description: Error message
                    example: "Search term is required"
        '500':
          description: Server error during search
          content:
            application/json:
              schema:
                type: object
                required:
                  - error
                  - details
                  - searchTerm
                properties:
                  error:
                    type: string
                    description: Error message
                    example: "Failed to perform search"
                  details:
                    type: string
                    description: Detailed error information
                    example: "GraphQL error: Invalid query structure"
                  searchTerm:
                    type: string
                    description: The search term that caused the error
                    example: "kjetting"

  /api/thule/lookup:
    get:
      operationId: lookupThuleProducts
      summary: Find compatible Thule products for a specific car
      description: |
        Returns Thule products for car specs. Uses fuzzy matching for manufacturer names (e.g., "mercedes" matches "MERCEDES BENZ") and Levenshtein distance for model matching. Scoring: complete sets (8 pts), single racks (3 pts), components (1 pt).
      parameters:
        - name: make
          in: query
          required: true
          description: Car manufacturer (flexible matching, e.g., "mercedes", "MERCEDES-BENZ", "Mercedes Benz" all work)
          schema:
            type: string
          example: MERCEDES-BENZ
        - name: model
          in: query
          required: true
          description: Car model
          schema:
            type: string
          example: e-tron
        - name: year
          in: query
          required: true
          description: Car model year
          schema:
            type: integer
            minimum: 1900
            maximum: 2100
          example: 2019
        - name: variation
          in: query
          required: false
          description: |
            Roof rail type. Auto-detects if not provided.
          schema:
            type: string
            enum:
              - med integrerte relinger
              - med takrenner, med høyt tak
              - med takrenner
              - med normalt tak
              - med integrerte relinger og klemfot
              - med normalt tak uten glasstak
              - med T-profil
              - Integrerte relinger og festepunktfot
              - med faste punkter
              - med takskinner
              - med hevede skinner
              - med faste punkter, uten glasstak
              - med faste punkter, med høyt tak
              - med fabrikkinstallert tverrstang
          example: med integrerte relinger
      responses:
        '200':
          description: Successful response with product matches
          content:
            application/json:
              schema:
                type: object
                required:
                  - success
                  - productGroups
                  - car
                  - k_type
                  - matchConfidence
                properties:
                  success:
                    type: boolean
                    description: Whether the lookup was successful
                  productGroups:
                    type: array
                    description: Groups of compatible Thule products (complete racks or individual components)
                    items:
                      type: object
                      required:
                        - type
                        - isPreferred
                        - products
                      properties:
                        type:
                          type: string
                          enum: [complete_rack, individual_components]
                          description: Type of product group
                        isPreferred:
                          type: boolean
                          description: Whether this group is the preferred solution
                        products:
                          type: array
                          description: List of compatible products in this group
                          items:
                            type: object
                            required:
                              - sku
                              - type
                              - url
                              - name
                            properties:
                              sku:
                                type: string
                                description: Product SKU
                                example: "721420"
                              type:
                                type: string
                                enum: [bar, foot, kit, complete_rack]
                                description: Product component type
                              url:
                                type: string
                                description: URL to product page
                                example: "https://bilxtra.no/lasteutstyr/tak/takstativ/rails/wingbar-edge-95-black-1-pk"
                              name:
                                type: string
                                description: Product name
                                example: "WINGBAR EDGE 95 BLACK 1-PK"
                              position:
                                type: string
                                enum: [front, rear]
                                description: Position for complete racks (optional)
                  k_type:
                    type: array
                    description: K-type specifications
                    items:
                      type: string
                    example: ["138779", "134328"]
                  car:
                    $ref: '#/components/schemas/CarInfo'
                  inferred:
                    type: object
                    description: Present when rail type was automatically detected
                    required:
                      - message
                      - detected
                      - original
                    properties:
                      message:
                        type: string
                        description: User-friendly message about what was automatically detected
                        example: "Rail type was automatically detected"
                      detected:
                        type: object
                        required:
                          - variation
                        properties:
                          variation:
                            type: string
                            description: The rail type that was automatically detected
                            example: "med normalt tak"
                      original:
                        type: object
                        required:
                          - variation
                        properties:
                          variation:
                            type: string
                            nullable: true
                            description: The original rail type that was provided (if any)
                            example: null
                  matchConfidence:
                    type: string
                    enum: [high, medium, low]
                    description: Confidence level of the match based on string similarity and inference
                    example: "high"
        '400':
          description: Bad request - missing or invalid parameters
          content:
            application/json:
              schema:
                type: object
                required:
                  - success
                  - productGroups
                  - message
                  - query
                properties:
                  success:
                    type: boolean
                    example: false
                  productGroups:
                    type: array
                    items: {}
                  message:
                    type: string
                    example: "Missing required parameters"
                  query:
                    type: object
                    properties:
                      make:
                        type: string
                        nullable: true
                      model:
                        type: string
                        nullable: true
                      year:
                        type: integer
                        nullable: true
                      variation:
                        type: string
                        nullable: true
        '500':
          description: Server error
          content:
            application/json:
              schema:
                type: object
                required:
                  - success
                  - error
                  - car
                  - productGroups
                  - k_type
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Failed to process request"
                  car:
                    type: object
                    properties:
                      make:
                        type: string
                        example: ""
                      model:
                        type: string
                        example: ""
                      variation:
                        type: string
                        example: ""
                  productGroups:
                    type: array
                    items: {}
                  k_type:
                    type: array
                    items: {}

  /api/vehicle-lookup:
    get:
      operationId: lookupVehicle
      summary: Get detailed vehicle information from a Norwegian license plate
      description: |
        Gets vehicle data from Vegvesen. Use for: 1. Finding Thule products 2. Selecting accessories 3. Verifying details.
      parameters:
        - name: plate
          in: query
          required: true
          description: Norwegian license plate
          schema:
            type: string
            pattern: ^[A-Z]{2}[0-9]{4,5}$
          example: "EB34033"
      responses:
        '200':
          description: Successful vehicle lookup
          content:
            application/json:
              schema:
                type: object
                required:
                  - success
                  - car
                properties:
                  success:
                    type: boolean
                    description: Whether the lookup was successful
                  car:
                    type: object
                    required:
                      - make
                      - model
                      - year
                      - doors
                    properties:
                      make:
                        type: string
                        description: Vehicle manufacturer
                        example: "AUDI"
                      model:
                        type: string
                        description: Vehicle model
                        example: "e-tron 50"
                      year:
                        type: integer
                        description: Manufacturing year
                        example: 2020
                      doors:
                        type: string
                        description: Number of physical doors (excluding trunk)
                        example: "4-dr"
                      color:
                        type: string
                        description: Vehicle color
                        example: "Blå"
                      bodyType:
                        type: string
                        description: Type of vehicle body
                        example: "Stasjonsvogn ISO-standard 3833:1977, def. nr. 3.1.1.4"
                      dimensions:
                        type: object
                        properties:
                          length:
                            type: integer
                            description: Vehicle length in mm
                            example: 4901
                          width:
                            type: integer
                            description: Vehicle width in mm
                            example: 1935
                          height:
                            type: integer
                            description: Vehicle height in mm
                            example: 1583
                      weight:
                        type: object
                        properties:
                          total:
                            type: integer
                            description: Vehicle weight in kg
                            example: 2465
                          maxRoofLoad:
                            type: integer
                            description: Maximum roof load in kg
                            example: 75
                          payload:
                            type: integer
                            description: Maximum payload in kg
                            example: 500
                          totalAllowed:
                            type: integer
                            description: Maximum total allowed weight in kg
                            example: 3040
                          trailerWeight:
                            type: object
                            properties:
                              withBrakes:
                                type: integer
                                description: Maximum trailer weight with brakes in kg
                                example: 1800
                              withoutBrakes:
                                type: integer
                                description: Maximum trailer weight without brakes in kg
                                example: 750
                              verticalLoad:
                                type: integer
                                description: Maximum vertical coupling load in kg
                                example: 80
                              totalTrainWeight:
                                type: integer
                                description: Maximum total train weight in kg
                                example: 4840
                      engine:
                        type: object
                        required:
                          - type
                        properties:
                          type:
                            type: string
                            enum: [electric, hybrid, conventional]
                            description: Type of engine/powertrain
                            example: "electric"
                          maxSpeed:
                            type: integer
                            description: Maximum speed in km/h
                            example: 190
                          motors:
                            type: array
                            description: List of electric motors (for electric/hybrid vehicles)
                            items:
                              type: object
                              properties:
                                power:
                                  type: object
                                  properties:
                                    hourly:
                                      type: integer
                                      description: Continuous power output in kW
                                      example: 70
                                    peak:
                                      type: integer
                                      description: Peak power output in kW
                                      example: 115
                                code:
                                  type: string
                                  description: Motor code
                                  example: "EAS"
                          transmission:
                            type: string
                            description: Transmission type
                            example: "Automat"
                      electric:
                        type: object
                        description: Electric vehicle specific data
                        properties:
                          range:
                            type: integer
                            description: Range in km (WLTP)
                            example: 295
                          consumption:
                            type: integer
                            description: Energy consumption in Wh/km
                            example: 251
                          emissionClass:
                            type: string
                            description: Emission class
                            example: "0-utslipp"
                      seating:
                        type: object
                        properties:
                          total:
                            type: integer
                            description: Total number of seats
                            example: 5
                          front:
                            type: integer
                            description: Number of front seats
                            example: 2
                      noise:
                        type: object
                        properties:
                          level:
                            type: integer
                            description: Noise level in dB
                            example: 68
                          source:
                            type: string
                            description: Source of noise measurement
                            example: "Produsent"
                  debug:
                    type: object
                    description: Additional technical data for debugging (only in development)
        '400':
          description: Bad request - invalid license plate format or missing parameter
          content:
            application/json:
              schema:
                type: object
                required:
                  - success
                  - error
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Invalid license plate format"
        '404':
          description: Vehicle not found
          content:
            application/json:
              schema:
                type: object
                required:
                  - success
                  - error
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Vehicle not found"
        '500':
          description: Server error during lookup
          content:
            application/json:
              schema:
                type: object
                required:
                  - success
                  - error
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Failed to fetch vehicle data"
                  debug:
                    type: object
                    description: Additional error details (only in development) 
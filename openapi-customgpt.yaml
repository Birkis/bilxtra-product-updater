openapi: 3.1.0
info:
  version: 1.0.0
  title: Bilxtra Product APIs
  description: APIs for searching Crystallize products and looking up compatible Thule products
  contact:
    url: https://bilxtra.no

servers:
  - url: https://bilxtra-product-updater.vercel.app
    description: Production API server

paths:
  /api/product-search:
    get:
      operationId: searchProducts
      summary: Search for products in the Crystallize catalog
      description: Returns a list of products matching the search term, with cleaned URLs for Bilxtra.no
      parameters:
        - name: q
          in: query
          required: true
          description: The search term to find products
          schema:
            type: string
      responses:
        '200':
          description: A list of products matching the search criteria
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required:
                    - name
                    - itemId
                    - url
                    - variant
                  properties:
                    name:
                      type: string
                      description: The name of the product
                      example: "Thule CL-10 030"
                    itemId:
                      type: string
                      description: Unique identifier for the product in Crystallize
                      example: "66d760987a3c149f55b38892"
                    url:
                      type: string
                      description: Clean URL to the product page on Bilxtra.no
                      example: "https://bilxtra.no/ukategorisert/thule-cl-10-030"
                    variant:
                      type: object
                      required:
                        - sku
                        - name
                        - image
                        - price
                        - stock
                      properties:
                        sku:
                          type: string
                          description: Product SKU (Stock Keeping Unit)
                          example: "THU-CL-10 030"
                        name:
                          type: string
                          description: Variant name/description
                          example: "10mm selvjusterende kjetting - Thule CL-10 030"
                        image:
                          type: object
                          required:
                            - url
                            - key
                          properties:
                            url:
                              type: string
                              description: URL to the product image
                              example: "https://media.crystallize.com/bilxtra-prod/24/9/3/552/1264-10mm-selvjusterende-kjetting-thule-cl-10-030-thu-cl-10-030.jpg"
                            key:
                              type: string
                              description: Crystallize media key for the image
                              example: "bilxtra-prod/24/9/3/552/1264-10mm-selvjusterende-kjetting-thule-cl-10-030-thu-cl-10-030.jpg"
                        price:
                          type: number
                          description: The default price of the product variant in NOK
                          example: 207.20
                        stock:
                          type: number
                          description: The current stock level of the product variant
                          example: 76
        '400':
          description: Bad request - missing search term
          content:
            application/json:
              schema:
                type: object
                required:
                  - error
                properties:
                  error:
                    type: string
                    description: Error message
                    example: "Search term is required"
        '500':
          description: Server error during search
          content:
            application/json:
              schema:
                type: object
                required:
                  - error
                  - details
                  - searchTerm
                properties:
                  error:
                    type: string
                    description: Error message
                    example: "Failed to perform search"
                  details:
                    type: string
                    description: Detailed error information
                    example: "GraphQL error: Invalid query structure"
                  searchTerm:
                    type: string
                    description: The search term that caused the error
                    example: "kjetting"

  /api/thule/lookup:
    get:
      operationId: lookupThuleProducts
      summary: Find compatible Thule products for a specific car
      description: |
        Returns compatible Thule products based on car specifications. Uses a scoring system:
        - Complete racks (3 points each)
        - Individual components (1 point each)
        Best match selected by: highest score, complete solutions preferred, then full component sets.
      parameters:
        - name: make
          in: query
          required: true
          description: Car manufacturer (e.g., Audi)
          schema:
            type: string
          example: Audi
        - name: model
          in: query
          required: true
          description: Car model (e.g., e-tron)
          schema:
            type: string
          example: e-tron
        - name: year
          in: query
          required: true
          description: Car model year
          schema:
            type: integer
            minimum: 1900
            maximum: 2100
          example: 2019
        - name: doors
          in: query
          required: true
          description: Number of doors specification (e.g., 5-dr)
          schema:
            type: string
            enum: [5-dr, 4-dr, 3-dr, 2-dr]
          example: 5-dr
        - name: variation
          in: query
          required: true
          description: Car variation/configuration
          schema:
            type: string
            enum:
              - med integrerte relinger
              - med takrenner, med høyt tak
              - med takrenner
              - med normalt tak
              - med integrerte relinger og klemfot
              - med normalt tak uten glasstak
              - med T-profil
              - Integrerte relinger og festepunktfot
              - med faste punkter
              - med takskinner
              - med hevede skinner
              - med faste punkter, uten glasstak
              - med faste punkter, med høyt tak
              - med fabrikkinstallert tverrstang
          example: med integrerte relinger
      responses:
        '200':
          description: Successful response with product matches
          content:
            application/json:
              schema:
                type: object
                required:
                  - success
                  - productGroups
                  - car
                  - k_type
                properties:
                  success:
                    type: boolean
                    description: Whether the lookup was successful
                  productGroups:
                    type: array
                    description: Groups of compatible Thule products
                    items:
                      type: object
                      required:
                        - type
                        - isPreferred
                        - products
                      properties:
                        type:
                          type: string
                          description: Type of product group
                          enum:
                            - complete_rack
                            - individual_components
                        isPreferred:
                          type: boolean
                          description: Whether this group represents the preferred solution
                        products:
                          type: array
                          description: List of products in this group
                          items:
                            type: object
                            required:
                              - sku
                              - name
                              - url
                              - type
                            properties:
                              sku:
                                type: string
                                description: Product SKU/ID
                                example: "710600"
                              name:
                                type: string
                                description: Product name/description
                                example: "Thule Edge Flush Rail"
                              url:
                                type: string
                                description: Product URL at bilxtra.no, null if not in catalog
                                nullable: true
                                example: "https://bilxtra.no/lasteutstyr/tak/takstativ/monteringssett/thule-evo-flush-rail"
                              type:
                                type: string
                                description: Product type
                                enum:
                                  - bar
                                  - foot
                                  - kit
                                  - complete_rack
                    example:
                      - type: complete_rack
                        isPreferred: true
                        products:
                          - sku: "721520"
                            type: "complete_rack"
                            name: "Thule WingBar Edge"
                            url: "https://bilxtra.no/lasteutstyr/tak/takstativ/komplett/thule-evo-clamp"
                      - type: individual_components
                        isPreferred: false
                        products:
                          - sku: "391000"
                            type: "bar"
                            name: "Thule WingBar Evo"
                            url: "https://bilxtra.no/lasteutstyr/tak/takstativ/takboyler/thule-wingbar-evo"
                          - sku: "710600"
                            type: "foot"
                            name: "Thule Edge Flush Rail"
                            url: "https://bilxtra.no/lasteutstyr/tak/takstativ/monteringssett/thule-evo-flush-rail"
                          - sku: "186046"
                            type: "kit"
                            name: "Thule Kit 6046"
                            url: "https://bilxtra.no/lasteutstyr/tak/takstativ/monteringssett/thule-kit-6046"
                  k_type:
                    type: array
                    description: K-type specifications
                    items:
                      type: string
                    example: ["138779", "134328"]
                  car:
                    type: object
                    description: Matched car details
                    required:
                      - make
                      - model
                      - variation
                      - doors
                      - yearRange
                    properties:
                      make:
                        type: string
                        description: Car manufacturer
                        example: "AUDI"
                      model:
                        type: string
                        description: Car model
                        example: "e-tron"
                      variation:
                        type: string
                        description: Car variation/configuration
                        example: "med integrerte relinger"
                      doors:
                        type: string
                        description: Number of doors specification
                        example: "5-dr"
                      yearRange:
                        type: object
                        description: Valid year range for this configuration
                        required:
                          - start
                          - end
                        properties:
                          start:
                            type: integer
                            description: Start year
                            example: 2019
                          end:
                            type: integer
                            description: End year
                            example: 2023
        '400':
          description: Bad request - missing or invalid parameters
          content:
            application/json:
              schema:
                type: object
                required:
                  - success
                  - productGroups
                  - message
                  - query
                properties:
                  success:
                    type: boolean
                    example: false
                  productGroups:
                    type: array
                    items: {}
                  message:
                    type: string
                    example: "Missing required parameters"
                  query:
                    type: object
                    properties:
                      make:
                        type: string
                        nullable: true
                      model:
                        type: string
                        nullable: true
                      year:
                        type: integer
                        nullable: true
                      doors:
                        type: string
                        nullable: true
                      variation:
                        type: string
                        nullable: true
        '500':
          description: Server error
          content:
            application/json:
              schema:
                type: object
                required:
                  - success
                  - error
                  - car
                  - productGroups
                  - k_type
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Failed to process request"
                  car:
                    type: object
                    properties:
                      make:
                        type: string
                        example: ""
                      model:
                        type: string
                        example: ""
                      variation:
                        type: string
                        example: ""
                      doors:
                        type: string
                        example: ""
                      yearRange:
                        type: object
                        properties:
                          start:
                            type: integer
                            example: 0
                          end:
                            type: integer
                            example: 0
                  productGroups:
                    type: array
                    items: {}
                  k_type:
                    type: array
                    items: {} 